<div id="deleteConfirmModal"
     class="hidden fixed inset-0 z-50 w-full h-full bg-gray-900/50 flex items-center justify-center"
     role="dialog" aria-modal="true" aria-labelledby="deleteConfirmTitle">
    <!-- Backdrop close -->
    <button class="absolute inset-0 w-full h-full" onclick="hideDeleteConfirmModal()" aria-label="Close"></button>

    <div class="relative w-[92%] sm:w-[520px] max-h-[90vh] overflow-y-auto bg-white rounded-2xl shadow-2xl border border-black/5">
        <header class="px-6 pt-6 pb-3 bg-gradient-to-br from-gray-50 to-white border-b border-black/5 flex items-start justify-between">
            <div>
                <h3 id="deleteConfirmTitle" class="text-2xl font-bold text-gray-900">
                    Delete Product
                </h3>
                <p id="deleteConfirmSubtitle" class="text-sm text-gray-600 mt-1">
                    Are you sure you want to delete this product? This action cannot be undone.
                </p>
            </div>
            <button type="button"
                    class="ml-4 text-gray-400 hover:text-gray-700 hover:bg-gray-100 rounded-lg p-2"
                    onclick="hideDeleteConfirmModal()" aria-label="Close">
                <svg viewBox="0 0 24 24" class="w-5 h-5" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                          d="M6.225 4.811a1 1 0 0 1 1.414 0L12 9.172l4.361-4.361a1 1 0 1 1 1.415 1.414L13.414 10.586l4.362 4.361a1 1 0 0 1-1.415 1.415L12 12l-4.361 4.362a1 1 0 0 1-1.414-1.415L10.586 10.586 6.225 6.225a1 1 0 0 1 0-1.414Z"/>
                </svg>
            </button>
        </header>

        <div class="px-6 py-6 space-y-3">
            <div class="rounded-lg bg-rose-50 border border-rose-200 px-3 py-2 text-rose-800 text-sm">
                This will permanently remove the product from your catalog.
            </div>
            <div class="text-sm text-gray-700">
                <span class="text-gray-500">Product:</span>
                <span id="deleteConfirmName" class="font-medium">â€”</span>
            </div>
        </div>

        <footer class="px-6 pb-6 pt-3 border-t border-gray-100 flex flex-col sm:flex-row gap-3">
            <button type="button"
                    class="order-2 sm:order-1 px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition"
                    onclick="hideDeleteConfirmModal()">Cancel</button>

            <button id="deleteConfirmBtn" type="button"
                    class="order-1 sm:order-2 inline-flex items-center justify-center rounded-lg bg-gradient-to-br from-rose-600 to-red-600 text-white font-bold px-4 py-2.5 shadow hover:-translate-y-0.5 hover:shadow-lg transition">
                Delete
            </button>
        </footer>
    </div>
</div>

<script>
    (function () {
        const modal      = document.getElementById('deleteConfirmModal');
        const nameEl     = document.getElementById('deleteConfirmName');
        const confirmBtn = document.getElementById('deleteConfirmBtn');

        let targetUrl = null;

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
            return '';
        }

        window.showDeleteConfirmModal = (productTitle, deleteUrl) => {
            targetUrl = deleteUrl || '';
            if (nameEl) nameEl.textContent = productTitle || 'Untitled';
            modal?.classList.remove('hidden');
        };
        window.hideDeleteConfirmModal = () => {
            targetUrl = null;
            modal?.classList.add('hidden');
        };

        if (confirmBtn && !confirmBtn._wired) {
            confirmBtn._wired = true;
            confirmBtn.addEventListener('click', async () => {
                if (!targetUrl) return;
                try {
                    const csrf = getCookie('csrftoken'); // requires {% csrf_token %} somewhere on page to set cookie

                    const res = await fetch(targetUrl, {
                        method: 'POST',                             // use POST for delete view
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrf
                        },
                        credentials: 'same-origin'
                    });

                    if (!res.ok) throw new Error('Delete failed');

                    // Close modal, toast, notify listeners
                    hideDeleteConfirmModal();
                    if (typeof showToast === 'function') {
                        showToast('Product deleted', 'The product has been removed.', 'success');
                    }
                    document.dispatchEvent(new CustomEvent('productDeleted'));

                    // product_detail.html may set this to go back to list
                    if (window.POST_DELETE_REDIRECT) {
                        window.location.href = window.POST_DELETE_REDIRECT;
                    }
                } catch (err) {
                    console.error(err);
                    if (typeof showToast === 'function') {
                        showToast('Delete failed', 'Please try again.', 'error');
                    }
                }
            });
        }

        // Esc closes
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') hideDeleteConfirmModal();
        });
    })();
</script>
